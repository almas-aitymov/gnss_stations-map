<!DOCTYPE html>
<html>
<head>
  <title>–ö–∞—Ä—Ç–∞ –±–∞–∑–æ–≤—ã—Ö —Å—Ç–∞–Ω—Ü–∏–π</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    #map { height: 100vh; }
    body { margin: 0; }
  </style>
</head>
<body>
  <div id="map"></div>

  <script>
    const providerColors = {
      "Geokurs": "green",
      "NCGPI": "blue",
      "Leica": "red",
      "South": "orange",
      "Default": "violet"
    };

    // üì° –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –∏–∫–æ–Ω–∫–∞ –±–∞–∑–æ–≤–æ–π —Å—Ç–∞–Ω—Ü–∏–∏
    const gnssIcon = new L.Icon({
      iconUrl: "https://almas-aitymov.github.io/gnss_stations-map/antenna.png",
      iconSize: [32, 32],
      iconAnchor: [16, 32],
      popupAnchor: [0, -32],
      shadowUrl: null
    });

    fetch('stations_combined.json')
      .then(response => response.json())
      .then(data => {
        const map = L.map('map').setView([48.5, 71.5], 5);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
          attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º
        const grouped = {};
        data.forEach(station => {
          const key = `${station.latitude},${station.longitude}`;
          if (!grouped[key]) grouped[key] = [];
          grouped[key].push(station);
        });

        Object.values(grouped).forEach(group => {
          const lat = group[0].latitude;
          const lon = group[0].longitude;

          if (lat == null || lon == null) {
            console.warn("–ü—Ä–æ–ø—É—â–µ–Ω–∞ —Å—Ç–∞–Ω—Ü–∏—è –±–µ–∑ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç:", group);
            return;
          }

          const color = providerColors[group[0].provider] || providerColors["Default"];

          const popup = group.map(station => `
            <b>${station.mountpoint}</b><br/>
            –ü—Ä–æ–≤–∞–π–¥–µ—Ä: ${station.provider}<br/>
            GNSS: ${station.gnss}<br/>
            –§–æ—Ä–º–∞—Ç: ${station.format}<br/>
            –û–±–Ω–æ–≤–ª–µ–Ω–æ: ${station.last_checked?.slice(0, 10) || ''}<br/>
            <hr>
          `).join('');

          // üîµ –ö—Ä—É–≥ –ø–æ–∫—Ä—ã—Ç–∏—è 30 –∫–º
          L.circle([lat, lon], {
            radius: 30000,
            color: color,
            fillColor: color,
            fillOpacity: 0.15,
            weight: 1
          }).addTo(map);

          // üìç –ú–∞—Ä–∫–µ—Ä —Å –∏–∫–æ–Ω–∫–æ–π –∞–Ω—Ç–µ–Ω–Ω—ã
          L.marker([lat, lon], { icon: gnssIcon })
            .addTo(map)
            .bindPopup(popup);
        });
      });
  </script>
</body>
</html>
